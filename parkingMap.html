<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ParkSpot Montevideo</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" />
    <style>
        html,
        body,
        #app {
            height: 100%;
        }

        #map {
            height: calc(100% - 136px);
        }

        .custom-marker {
            border-radius: 50%;
            color: white;
            font-weight: bold;
            display: flex;
            justify-content: center;
            align-items: center;
            width: 30px;
            height: 30px;
        }

        .custom-cluster {
            border-radius: 50%;
            color: white;
            font-weight: bold;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .btn-custom {
            background: linear-gradient(to right, #a8e063, #56ab2f);
            border: none;
            border-radius: 20px;
            color: white;
        }

        .btn-custom:hover {
            background: linear-gradient(to right, #56ab2f, #a8e063);
        }

        .form-control {
            border-radius: 20px;
        }

        #nearest-spot-button {
            position: absolute;
            top: 70vh;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
        }

        .rounded-circle {
            background: linear-gradient(to right, #a8e063, #56ab2f);

        }
    </style>
</head>

<body>
    <div id="app" class="d-flex flex-column">
        <header class="bg-light p-3">
            <div class="container">
                <div class="row align-items-center">
                    <div class="col">
                        <div class="d-flex align-items-center">
                            <div class="bg-primary rounded-circle me-3" style="width: 40px; height: 40px;"></div>
                            <h1 class="h4 mb-0">ParkSpot Montevideo</h1>
                        </div>
                    </div>
                    <div class="col">
                        <div class="input-group">
                            <input type="text" id="search-input" class="form-control" placeholder="Buscar dirección...">
                            <button id="search-button" class="btn btn-custom ">Buscar</button>

                        </div>
                    </div>
                </div>
            </div>
        </header>
        <div id="map">
            <button id="nearest-spot-button" class="btn btn-custom">Estacionamiento cercano</button>
        </div>
        <footer class="bg-light p-3 text-center">
            <p class="mb-0">Espacio para publicidad</p>
        </footer>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>
    <script>
        // Inicialización del mapa
        const map = L.map('map').setView([-34.9011, -56.1645], 13);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

        // Generación de puntos de estacionamiento aleatorios
        function generateParkingSpots(count) {
            const spots = [];
            const centerLat = -34.9011;
            const centerLng = -56.1645;
            const spread = 0.03; // Aproximadamente 3km en cada dirección

            for (let i = 0; i < count; i++) {
                const lat = centerLat + (Math.random() - 0.5) * spread;
                const lng = centerLng + (Math.random() - 0.5) * spread;
                spots.push({
                    id: i + 1,
                    lat,
                    lng,
                    name: `Estacionamiento ${i + 1}`,
                    availableSpots: Math.floor(Math.random() * 10) + 1 // 1 a 10 espacios disponibles
                });
            }

            return spots;
        }

        const parkingSpots = generateParkingSpots(200);

        // Función para determinar el color basado en la disponibilidad
        function getColorByAvailability(availableSpots) {
            if (availableSpots > 7) return '#28a745'; // Verde para alta disponibilidad
            if (availableSpots > 3) return '#ffc107'; // Amarillo para disponibilidad media
            return '#dc3545'; // Rojo para baja disponibilidad
        }

        // Creación de marcadores y clusters
        const markers = L.markerClusterGroup({
            iconCreateFunction: function (cluster) {
                const childCount = cluster.getChildCount();
                const totalSpots = cluster.getAllChildMarkers().reduce((total, marker) => {
                    return total + marker.options.parkingSpot.availableSpots;
                }, 0);

                let c = ' marker-cluster-';
                if (totalSpots < 10) {
                    c += 'small';
                } else if (totalSpots < 50) {
                    c += 'medium';
                } else {
                    c += 'large';
                }

                return new L.DivIcon({
                    html: '<div><span>' + totalSpots + '</span></div>',
                    className: 'custom-cluster' + c,
                    iconSize: new L.Point(40, 40)
                });
            }
        });

        parkingSpots.forEach(spot => {
            const marker = L.marker([spot.lat, spot.lng], {
                icon: L.divIcon({
                    className: 'custom-marker',
                    html: `<div style="background-color: ${getColorByAvailability(spot.availableSpots)}; width: 100%; height: 100%; display: flex; justify-content: center; align-items: center;">${spot.availableSpots}</div>`,
                    iconSize: [30, 30]
                }),
                title: spot.name,
                parkingSpot: spot
            });

            marker.bindPopup(`
                <b>${spot.name}</b><br>
                Espacios disponibles: ${spot.availableSpots}<br>
                <button class="btn btn-custom" onclick="shareLocation(${spot.lat}, ${spot.lng})">Compartir ubicación</button>
            `);
            markers.addLayer(marker);
        });

        map.addLayer(markers);

        // Funcionalidad de búsqueda
        document.getElementById('search-button').addEventListener('click', async () => {
            const query = document.getElementById('search-input').value;
            if (!query) return;

            try {
                const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}, Montevideo&limit=1`);
                const data = await response.json();

                if (data && data.length > 0) {
                    const { lat, lon } = data[0];
                    map.setView([parseFloat(lat), parseFloat(lon)], 18);
                } else {
                    alert('No se encontró la dirección. Por favor, intenta con una búsqueda más específica.');
                }
            } catch (error) {
                console.error('Error searching for address:', error);
                alert('Hubo un error al buscar la dirección. Por favor, inténtalo de nuevo.');
            }
        });



        // Funcionalidad de encontrar estacionamiento cercano
        document.getElementById('nearest-spot-button').addEventListener('click', () => {
            if ('geolocation' in navigator) {
                navigator.geolocation.getCurrentPosition((position) => {
                    const userLat = position.coords.latitude;
                    const userLng = position.coords.longitude;

                    let nearestSpot = null;
                    let minDistance = Infinity;

                    parkingSpots.forEach((spot) => {
                        if (spot.availableSpots > 0) {
                            const distance = Math.sqrt(
                                Math.pow(spot.lat - userLat, 2) + Math.pow(spot.lng - userLng, 2)
                            );
                            if (distance < minDistance) {
                                minDistance = distance;
                                nearestSpot = spot;
                            }
                        }
                    });

                    if (nearestSpot) {
                        map.setView([nearestSpot.lat, nearestSpot.lng], 18);
                        L.popup()
                            .setLatLng([nearestSpot.lat, nearestSpot.lng])
                            .setContent(`<b>${nearestSpot.name}</b><br>Espacios disponibles: ${nearestSpot.availableSpots}<br><button class="btn btn-custom" onclick="shareLocation(${nearestSpot.lat}, ${nearestSpot.lng})">Compartir ubicación</button>`)
                            .openOn(map);
                    } else {
                        alert('Lo sentimos, no hay estacionamientos disponibles en este momento.');
                    }
                }, (error) => {
                    console.error("Error getting user location:", error);
                    alert('No se pudo obtener tu ubicación. Por favor, verifica que has dado permiso de ubicación a la aplicación.');
                });
            } else {
                alert('Geolocalización no está disponible en tu navegador.');
            }
        });
        function shareLocation(lat, lng) {
            const url = `https://www.google.com/maps?q=${lat},${lng}`;
            if (navigator.share) {
                navigator.share({
                    title: 'Ubicación de Estacionamiento',
                    text: 'Mira este punto de estacionamiento:',
                    url: url
                }).then(() => {
                    console.log('Ubicación compartida exitosamente');
                }).catch((error) => {
                    console.error('Error al compartir la ubicación:', error);
                });
            } else {
                // Fallback para navegadores que no soportan la API de Web Share
                prompt('Copia este enlace para compartir:', url);
            }
        }
    </script>
</body>

</html>